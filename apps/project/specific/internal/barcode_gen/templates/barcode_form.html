{% extends 'raw.html' %}

{% load i18n %}

{% block title %}
    {% trans 'Barcode Generator' %}
{% endblock title %}

{% block meta %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
{% endblock meta %}

{% block third_css %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock third_css %}


{% block body_properties %}
    class="container"
{% endblock body_properties %}

{% block main %}
    <h2 class="my-4"></h2>

    <form id="barcodeForm" method="post">
        {% csrf_token %}

        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="id_reference" placeholder="{% trans 'Reference' %}" name="id_reference" required>
            <label for="id_reference">{% trans 'Reference' %}</label>
        </div>

        <div class="form-floating mb-3">
            <textarea type="text" class="form-control" id="id_description" placeholder="{% trans 'Reference' %}" name="id_description" style="height: 100px"></textarea>
            <label for="id_description">{% trans 'Description' %}</label>
        </div>

        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="id_custom_text_input" placeholder="{% trans 'Custom Text' %}" name="id_custom_text_input" required>
            <label for="id_custom_text_input">{% trans 'Custom Text' %}</label>
        </div>


        <div class="row g-2">
            <div class="col-md">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="id_include_nit">
                    <label class="form-check-label" for="id_include_nit">{% trans 'Include NIT' %}</label>
                </div>
            </div>
            <div class="col-md">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="id_include_date">
                    <label class="form-check-label" for="id_include_date">{% trans 'Include Date (DDMMYYYY)' %}</label>
                </div>
            </div>
            <div class="col-md">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="id_include_random_code">
                    <label class="form-check-label" for="id_include_random_code">{% trans 'Include Random Code (4 digits)' %}</label>
                </div>
            </div>
          </div>



          <div class="d-grid gap-2">
            <button type="button" id="generateBarcode" class="btn btn-primary">{% trans 'Next' %}</button>
          </div>

    </form>
{% endblock main %}
    
{% block content %}
    <div id="barcodeOutput" class="mt-4 text-center" style="display:none;">
        <img id="barcodeImage" src="{{ barcode_image }}" alt="{% trans 'Bar Code' %}"/>
        <div class="d-grid gap-2">
            <a id="downloadLink" download class="btn btn-success mt-3">{% trans 'Download' %}</a>
        </div>
    </div>
{% endblock content %}

{% block body_third_js %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock body_third_js %}

{% block body_custom_js %}
    <script>
        $(document).ready(function () {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
            $("#generateBarcode").click(function () {
                // Validación de campos
                const isValid = validateForm();
                if (!isValid) {
                    alert("Por favor, completa todos los campos requeridos.");
                    return;
                }
        
                const reference = $("#id_reference").val();
                const description = $("#id_description").val();
                const customTextInput = $("#id_custom_text_input").val();
                const includeNIT = $("#id_include_nit").is(":checked");
                const includeDate = $("#id_include_date").is(":checked");
                const includeRandomCode = $("#id_include_random_code").is(":checked");
        
                // Petición AJAX
                $.ajax({
                    url: "{% url 'barcode_gen:barcode_generate' %}",
                    type: "POST",
                    headers: {
                        "X-CSRFToken": csrftoken,
                    },
                    data: {
                        reference: reference,
                        description: description,
                        custom_text_input: customTextInput,
                        include_nit: includeNIT,
                        include_date: includeDate,
                        include_random_code: includeRandomCode
                    },
                    success: function (response) {
                        $("#barcodeOutput").show();
                        const reference = $("#id_reference").val().trim();
                        const imageUrl = response.barcode_image;
                        $("#barcodeImage").attr("src", imageUrl);
                        $("#downloadLink").attr("href", imageUrl);
                        $("#downloadLink").attr("download", `${reference}.png`);
                    },
                    error: function (xhr) {
                        alert(xhr.responseJSON.error);
                    }
                });
            });
        
            // Función para validar los campos del formulario
            function validateForm() {
                let isValid = true;
        
                // Campos requeridos
                if ($("#id_reference").val().trim() === "") {
                    $("#id_reference").addClass("is-invalid");
                    isValid = false;
                } else {
                    $("#id_reference").removeClass("is-invalid");
                }
        
                if ($("#id_custom_text_input").val().trim() === "") {
                    $("#id_custom_text_input").addClass("is-invalid");
                    isValid = false;
                } else {
                    $("#id_custom_text_input").removeClass("is-invalid");
                }
        
                return isValid;
            }
        });
    </script>
{% endblock body_custom_js %}
